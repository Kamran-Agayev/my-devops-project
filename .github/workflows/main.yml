name: Deploy Website
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
  script: |
            # 1. –ì–æ—Ç–æ–≤–∏–º –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            mkdir -p ~/my_app
            cd ~/my_app

            # 2. –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
            echo "<html><body style='text-align:center;padding-top:100px;'><h1>üöÄ DevOps Mastery: SUCCESS!</h1><p>Deploy version: ${{ github.sha }}</p></body></html>" > index.html
            
            echo "FROM nginx:alpine
            COPY index.html /usr/share/nginx/html/index.html
            RUN chmod 644 /usr/share/nginx/html/index.html" > Dockerfile

            # 3. –°–æ–±–∏—Ä–∞–µ–º —Å–≤–µ–∂–∏–π –æ–±—Ä–∞–∑
            sudo docker build -t my-site-image .

            # 4. –í–ù–ò–ú–ê–ù–ò–ï: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–∞ 80 –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ã—á–Ω—ã–π Nginx, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–∞–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ
            sudo systemctl stop nginx || true
            sudo systemctl disable nginx || true
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º –ª—é–±–æ–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 80 (–Ω–∞–ø—Ä–∏–º–µ—Ä, Apache)
            sudo fuser -k 80/tcp || true
            
            # 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            sudo docker rm -f my-website || true
            sudo docker run -d --name my-website -p 8080:80 --restart always my-site-image
